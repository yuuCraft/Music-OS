<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Music OS ~Music Manager~</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
  :root{
    --bg:#0f1216; --bg2:#0b0e12;
    --panel:#171b22; --panel2:#1b2028;
    --accent:#4da3ff; --accent2:#7bffb2;
    --text:#e8edf5; --muted:#9aa7b6; --danger:#ff6b6b; --border:#263042;
    --input-bg:#ffffff; --input-text:#000000; --input-border:#cfd8e3; --input-muted:#5b6b7f;
    --bluegrad: linear-gradient(90deg,#2a6adf,#4da3ff);
  }
  .theme-lightgreen{
    --bg:#eaf7ef; --bg2:#dff3e7; --panel:#f6fbf8; --panel2:#eef7f2;
    --text:#0f1a14; --muted:#4b6a57; --border:#cfe7d8; --input-bg:#ffffff; --input-text:#0f1a14; --input-border:#cfe7d8;
  }
  .theme-beige{
    --bg:#f7f3ea; --bg2:#f2ecdf; --panel:#fbf8f1; --panel2:#f4efe4;
    --text:#1a1710; --muted:#6b5f4b; --border:#e6dcc7; --input-bg:#ffffff; --input-text:#1a1710; --input-border:#e6dcc7;
  }
  .theme-lightblue{
    --bg:#eaf3fb; --bg2:#e1eef8; --panel:#f6faff; --panel2:#eef5fc;
    --text:#0f1621; --muted:#4b5f7a; --border:#cfe0f1; --input-bg:#ffffff; --input-text:#0f1621; --input-border:#cfe0f1;
  }

  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; background:linear-gradient(180deg,var(--bg),var(--bg2));
    color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Sans",Meiryo,sans-serif;
  }

  header{
    display:flex; align-items:center; gap:16px;
    padding:16px 20px; border-bottom:1px solid var(--border);
    position:sticky; top:0; z-index:20; background:rgba(0,0,0,.06); backdrop-filter:saturate(1.2) blur(6px);
  }
  header .brand{ font-weight:700; letter-spacing:.3px }
  header .search{ flex:1; display:flex; gap:8px; align-items:center }
  .search input{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--input-border);
    background:var(--input-bg); color:var(--input-text); outline:none; transition:.15s;
  }
  .search input:focus{ border-color:var(--accent); box-shadow:0 0 0 2px rgba(77,163,255,.25) }
  .search select{
    padding:10px 12px; border-radius:10px; border:1px solid var(--input-border);
    background:var(--input-bg); color:var(--input-text);
  }
  .btn{
    appearance:none; border:1px solid var(--border); background:linear-gradient(180deg,var(--panel2),var(--panel));
    color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; transition:.15s; font-weight:600;
  }
  .btn:hover{ border-color:var(--accent); box-shadow:0 6px 16px rgba(77,163,255,.18) }
  .btn.primary{ border-color:var(--accent); background:linear-gradient(180deg,#2a6adf,#1f4fb0); color:#fff }
  .btn.danger{ border-color:var(--danger); background:linear-gradient(180deg,#ff7f7f,#d85a5a); color:#fff }

  main{
    display:grid; grid-template-columns: 240px 1fr 360px; gap:16px;
    max-width:1400px; margin:16px auto; padding:0 16px;
  }
  aside{
    background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden;
  }
  .aside-header{ padding:12px 14px; border-bottom:1px solid var(--border); font-size:14px }
  .aside-content{ padding:10px }
  .nav{ display:flex; flex-direction:column; gap:6px }
  .nav button{
    text-align:left; padding:10px 12px; border-radius:10px; border:1px solid transparent; background:transparent; color:var(--text);
    cursor:pointer;
  }
  .nav button.active{ border-color:var(--accent); background:rgba(77,163,255,.12) }

  .card{
    background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden;
    box-shadow:0 10px 30px rgba(0,0,0,.08);
  }
  .card h2{ margin:0; padding:12px 14px; border-bottom:1px solid var(--border); font-size:16px }
  .content{ padding:12px }

  .toolbar{ display:flex; gap:8px; align-items:center; margin-bottom:10px }
  .drop{
    border:2px dashed var(--border); border-radius:12px; padding:18px; text-align:center; transition:.2s;
    background:linear-gradient(180deg,rgba(77,163,255,.08),transparent);
  }
  .grid{
    display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:12px;
  }
  .tile{
    background:var(--panel2); border:1px solid var(--border); border-radius:12px; overflow:hidden; cursor:pointer;
    display:flex; flex-direction:column;
  }
  .tile .cover-square{
    width:100%; aspect-ratio:1/1; background:#0b0f14; display:flex; align-items:center; justify-content:center; position:relative;
  }
  .tile .cover-square img{ width:100%; height:100%; object-fit:cover; display:block }
  .tile .cover-square .note{ position:absolute; font-size:28px; color:#4da3ff }
  .tile .meta{ padding:8px; display:flex; flex-direction:column; gap:4px }
  .tile .title{ font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  .tile .artist{ font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis }

  .list{ display:grid; grid-template-columns: 2fr 1.5fr 1.5fr .6fr .6fr .8fr; gap:8px; align-items:center }
  .list .head{ color:var(--muted); font-size:12px }

  .now{ display:flex; flex-direction:column; gap:10px }
  .now .track{
    display:flex; gap:12px; align-items:center; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--panel2);
  }
  .np-cover{
    width:72px; aspect-ratio:1/1; border-radius:10px; background:#0b0f14; border:1px solid var(--border);
    display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden;
  }
  .np-cover img{ width:100%; height:100%; object-fit:cover; }
  .np-cover .note{ position:absolute; font-size:28px; color:#4da3ff; }
  .progress{ height:6px; border-radius:999px; background:rgba(77,163,255,.15); overflow:hidden }
  .progress .bar{ height:100%; width:0%; background:var(--bluegrad) }
  .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .controls .btn{ padding:6px 10px }
  .controls input[type="range"]{ flex:1 }
  .queue{ border:1px solid var(--border); border-radius:12px; overflow:hidden }
  .queue .item{ display:flex; gap:8px; align-items:center; padding:8px 10px; border-bottom:1px solid var(--border); cursor:pointer }
  .queue .item:last-child{ border-bottom:none }
  .queue .item:hover{ background:rgba(77,163,255,.08) }

  label{ font-size:12px; color:var(--muted); margin-bottom:6px; display:block }
  input[type="text"], input[type="number"], select, textarea{
    width:100%; padding:10px 12px; border-radius:10px;
    border:1px solid var(--input-border);
    background:var(--input-bg); color:var(--input-text);
    outline:none; transition:.15s; box-shadow:0 1px 0 rgba(0,0,0,.03) inset;
  }
  input::placeholder, textarea::placeholder{ color: var(--input-muted) }
  input:focus, textarea:focus, select:focus{ border-color:var(--accent); box-shadow:0 0 0 2px rgba(77,163,255,.25) }
  textarea{ min-height:80px; resize:vertical }

  .small{ font-size:12px; color:var(--muted) }

  @media (max-width: 1100px){
    main{ grid-template-columns: 220px 1fr }
    .now{ margin-top:16px }
    .queue{ display:none }
  }
</style>
</head>
<body>
  <header>
    <div class="brand">Music OS for Web</div>
    <div class="search">
      <input id="search" type="text" placeholder="検索（曲名・アーティスト・アルバム）" />
      <select id="sort">
        <option value="title">タイトル順</option>
        <option value="artist">アーティスト順</option>
        <option value="album">アルバム順</option>
        <option value="added">追加日時</option>
      </select>
      <button id="openWorkspace" class="btn primary">フォルダを開く</button>
    </div>
  </header>

  <main>
    <aside>
      <div class="aside-header">ナビゲーション</div>
      <div class="aside-content">
        <div class="nav">
          <button data-view="artists" class="active">アーティスト</button>
          <button data-view="library">ライブラリ</button>
          <button data-view="playlists">プレイリスト</button>
          <button data-view="favorites">お気に入り</button>
          <button data-view="settings">設定</button>
          <button data-view="id3">ID3タグ編集</button>
        </div>
        <hr style="border-color:var(--border)">
        <div class="small">ドラッグ＆ドロップでMP3を追加できます。</div>
      </div>
    </aside>

    <section class="card" id="view-artists">
      <h2>アーティスト一覧</h2>
      <div class="content" id="artistList"></div>
    </section>

    <section class="card" id="view-library" style="display:none">
      <h2>ライブラリ</h2>
      <div class="content">
        <div id="drop" class="drop" tabindex="0">
          <p><strong>MP3をここにドロップ</strong></p>
          <p class="small">対応: MP3（ID3v2.3/2.4の基本フレーム）</p>
        </div>
        <div class="toolbar">
          <button id="viewGrid" class="btn primary">グリッド</button>
          <button id="viewList" class="btn">リスト</button>
          <button id="newPlaylist" class="btn">新規プレイリスト</button>
        </div>
        <div id="libraryView" class="grid"></div>
      </div>
    </section>

    <section class="card" id="view-playlists" style="display:none">
      <h2>プレイリスト</h2>
      <div class="content" id="playlistsView">
        <div class="small">プレイリストは今後保存に対応予定。</div>
      </div>
    </section>

    <section class="card" id="view-favorites" style="display:none">
      <h2>お気に入り</h2>
      <div class="content" id="favoritesView">
        <div class="small">★でお気に入りに追加予定。</div>
      </div>
    </section>

    <section class="card" id="view-settings" style="display:none">
      <h2>設定</h2>
      <div class="content">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px">
          <div>
            <label>背景色（テーマ）</label>
            <select id="bgColor">
              <option value="default">ダーク（標準）</option>
              <option value="lightgreen">ライトグリーン</option>
              <option value="beige">ベージュ</option>
              <option value="lightblue">ライトブルー</option>
            </select>
          </div>
          <div>
            <label><input id="bassBoost" type="checkbox"> 低音ブースト</label>
          </div>
          <div>
            <label>低音調整</label>
            <input id="bass" type="range" min="-12" max="12" value="0" />
          </div>
          <div>
            <label>高音調整</label>
            <input id="treble" type="range" min="-12" max="12" value="0" />
          </div>
        </div>

        <hr style="margin:12px 0">

        <h3 style="margin:0 0 8px">バックアップダウンロード</h3>
        <label>保存形式</label>
        <select id="backupMode">
          <option value="album">アルバムごと</option>
          <option value="playlist">プレイリストごと</option>
          <option value="single">バラ（単曲）</option>
        </select>
        <button id="backupDownload" class="btn primary" style="margin-top:8px">ダウンロード</button>
        <div class="small" style="margin-top:4px">選択した形式で全曲をZIPにまとめて保存します（ファイル名: Backup-Music.zip）。</div>
      </div>
    </section>

    <section class="card" id="view-id3" style="display:none">
      <h2>ID3タグ編集</h2>
      <div class="content" id="id3Editor">
        <div class="small">ライブラリから曲を選ぶと編集できます（メタデータはローカルに自動保存）。</div>
      </div>
    </section>

    <section class="card">
      <h2>Now Playing</h2>
      <div class="content now">
        <div class="track">
          <div class="np-cover" id="npCoverBox">
            <img id="npCoverImg" alt="cover" style="display:none" />
            <div id="npCoverNote" class="note">♬</div>
          </div>
          <div style="flex:1">
            <div id="npTitle" style="font-weight:600">—</div>
            <div id="npArtist" class="small">—</div>

            <div class="progress" style="margin-top:6px"><div id="npBar" class="bar"></div></div>

            <div class="controls" style="margin-top:8px">
              <button id="btnPrev" class="btn">◀︎</button>
              <button id="btnPlay" class="btn primary" title="再生/一時停止">▶️</button>
              <button id="btnNext" class="btn">▶︎</button>
              <input id="seek" type="range" min="0" max="1000" value="0" />
            </div>

            <div id="npTime" class="small" style="margin-top:4px">0:00 / 0:00</div>
            <div style="margin-top:6px"><button id="btnEdit" class="btn">ID3編集</button></div>
          </div>
        </div>

        <div class="queue">
          <div style="padding:8px 10px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center">
            <div>再生キュー</div>
            <div><button id="clearQueue" class="btn">クリア</button></div>
          </div>
          <div id="queueList"></div>
        </div>
      </div>
    </section>
  </main>

<script>
/* =========================
   Simple persistence (localStorage)
   ========================= */
const LS_KEY_SETTINGS = 'xmm_settings';
const LS_KEY_META = 'xmm_meta';

function loadSettings(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY_SETTINGS)) || { theme:'default', bass:0, treble:0, bassBoost:false }; }
  catch{ return { theme:'default', bass:0, treble:0, bassBoost:false }; }
}
function saveSettings(s){ localStorage.setItem(LS_KEY_SETTINGS, JSON.stringify(s)); }
function loadMeta(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY_META)) || {}; }
  catch{ return {}; }
}
function saveMeta(m){ localStorage.setItem(LS_KEY_META, JSON.stringify(m)); }

/* =========================
   App State
   ========================= */
let library = []; // [{id,name,title,artist,album,year,size,blob,cover,added}]
let queue = [];
let currentId = null;
let gridView = true;
let settings = loadSettings();

/* Audio chain */
const audio = new Audio();
let audioCtx = null;
let mediaNode = null;
let bassFilter = null;
let trebleFilter = null;
let boostGain = null;
let playing = false;

/* Elements */
const el = {
  search: document.getElementById('search'),
  sort: document.getElementById('sort'),
  openWorkspace: document.getElementById('openWorkspace'),
  drop: document.getElementById('drop'),
  libraryView: document.getElementById('libraryView'),
  viewGrid: document.getElementById('viewGrid'),
  viewList: document.getElementById('viewList'),
  artistList: document.getElementById('artistList'),
  id3Editor: document.getElementById('id3Editor'),
  // Now Playing
  npCoverImg: document.getElementById('npCoverImg'),
  npCoverNote: document.getElementById('npCoverNote'),
  npTitle: document.getElementById('npTitle'),
  npArtist: document.getElementById('npArtist'),
  npBar: document.getElementById('npBar'),
  seek: document.getElementById('seek'),
  npTime: document.getElementById('npTime'),
  btnPrev: document.getElementById('btnPrev'),
  btnPlay: document.getElementById('btnPlay'),
  btnNext: document.getElementById('btnNext'),
  btnEdit: document.getElementById('btnEdit'),
  queueList: document.getElementById('queueList'),
  clearQueue: document.getElementById('clearQueue'),
  // Settings
  bgColor: document.getElementById('bgColor'),
  bass: document.getElementById('bass'),
  treble: document.getElementById('treble'),
  bassBoost: document.getElementById('bassBoost'),
  // Backup
  backupMode: document.getElementById('backupMode'),
  backupDownload: document.getElementById('backupDownload'),
};
const views = {
  artists: document.getElementById('view-artists'),
  library: document.getElementById('view-library'),
  playlists: document.getElementById('view-playlists'),
  favorites: document.getElementById('view-favorites'),
  settings: document.getElementById('view-settings'),
  id3: document.getElementById('view-id3'),
};

/* =========================
   Navigation
   ========================= */
document.querySelectorAll('.nav button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const target = btn.dataset.view;
    Object.values(views).forEach(v=> v.style.display='none');
    document.querySelectorAll('.nav button').forEach(b=> b.classList.remove('active'));
    btn.classList.add('active');
    views[target].style.display='block';
    if(target==='artists') renderArtists();
    if(target==='id3') renderId3Editor();
  });
});

/* =========================
   Drag & Drop (file://対応)
   ========================= */
['dragenter','dragover'].forEach(ev=>{
  el.drop.addEventListener(ev, e=>{ e.preventDefault(); el.drop.style.borderColor='var(--accent)'; });
});
['dragleave','drop'].forEach(ev=>{
  el.drop.addEventListener(ev, e=>{ e.preventDefault(); el.drop.style.borderColor='var(--border)'; });
});
el.drop.addEventListener('drop', async e=>{
  const files = Array.from(e.dataTransfer.files||[]);
  const meta = loadMeta();
  for(const f of files){
    if(!f.type.includes('mpeg') && !f.name.toLowerCase().endsWith('.mp3')) continue;
    const id = crypto.randomUUID();
    const blob = new Blob([await f.arrayBuffer()], { type: 'audio/mpeg' });
    const track = {
      id, name: f.name,
      title: f.name.replace(/\.mp3$/i,''),
      artist: '', album: '', year: '',
      size: f.size, blob, cover: null, added: Date.now()
    };
    library.push(track);
    meta[f.name] = { id:track.id, title:track.title, artist:'', album:'', year:'', added:track.added, cover:null };
  }
  saveMeta(meta);
  renderLibrary();
  renderArtists();
});

/* =========================
   Render helpers
   ========================= */
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
const fmtBytes = (n)=>{ const u=['B','KB','MB','GB']; let i=0; while(n>1024&&i<u.length-1){n/=1024;i++;} return `${n.toFixed(2)} ${u[i]}`; };

function renderLibrary(){
  const q = el.search.value.trim().toLowerCase();
  const sortKey = el.sort.value;
  let items = library.slice();
  if(q){
    items = items.filter(t=> [t.title,t.artist,t.album].some(v=> (v||'').toLowerCase().includes(q)));
  }
  items.sort((a,b)=>{
    if(sortKey==='added') return b.added - a.added;
    const va=(a[sortKey]||'').toLowerCase(), vb=(b[sortKey]||'').toLowerCase();
    return va.localeCompare(vb,'ja');
  });

  el.libraryView.innerHTML='';
  if(gridView){
    el.libraryView.className='grid';
    for(const t of items){
      const div = document.createElement('div');
      div.className='tile';
      div.innerHTML = `
        <div class="cover-square">
          ${t.cover?`<img src="${t.cover}">`:`<div class="note">♬</div>`}
        </div>
        <div class="meta">
          <div class="title" title="${escapeHtml(t.title)}">${escapeHtml(t.title)}</div>
          <div class="artist" title="${escapeHtml(t.artist)}">${escapeHtml(t.artist||'—')}</div>
          <div class="small">${escapeHtml(t.album||'')} ${t.year?('• '+t.year):''}</div>
          <div class="small">${fmtBytes(t.size)}</div>
          <div style="display:flex; gap:6px; margin-top:6px">
            <button class="btn primary" title="再生">▶️</button>
            <button class="btn" title="ID3編集">ID3</button>
            <button class="btn danger" title="削除">削除</button>
          </div>
        </div>`;
      div.querySelector('.btn.primary').onclick = ()=> addToQueueAndPlay(t.id);
      div.querySelector('.btn').onclick = ()=> openId3EditorInline(t.id);
      div.querySelector('.btn.danger').onclick = ()=> deleteTrack(t.id);
      el.libraryView.appendChild(div);
    }
  }else{
    el.libraryView.className='list';
    const heads = ['タイトル','アーティスト','アルバム','年','サイズ','操作'];
    heads.forEach(h=>{ const c=document.createElement('div'); c.className='head'; c.textContent=h; el.libraryView.appendChild(c); });
    for(const t of items){
      const c1=document.createElement('div'); c1.textContent=t.title;
      const c2=document.createElement('div'); c2.textContent=t.artist||'—';
      const c3=document.createElement('div'); c3.textContent=t.album||'—';
      const c4=document.createElement('div'); c4.textContent=t.year||'—';
      const c5=document.createElement('div'); c5.textContent=fmtBytes(t.size);
      const c6=document.createElement('div');
      const playBtn=document.createElement('button'); playBtn.className='btn primary'; playBtn.textContent='▶️'; playBtn.onclick=()=>addToQueueAndPlay(t.id);
      const editBtn=document.createElement('button'); editBtn.className='btn'; editBtn.textContent='ID3'; editBtn.onclick=()=>openId3EditorInline(t.id);
      const delBtn=document.createElement('button'); delBtn.className='btn danger'; delBtn.textContent='削除'; delBtn.onclick=()=>deleteTrack(t.id);
      c6.append(playBtn, editBtn, delBtn);
      [c1,c2,c3,c4,c5,c6].forEach(c=> el.libraryView.appendChild(c));
    }
  }
  renderQueue();
}

async function deleteTrack(id){
  const t = library.find(x=>x.id===id); if(!t) return;
  if(!confirm(`削除しますか？\n${t.name}`)) return;
  library = library.filter(x=>x.id!==id);
  const meta = loadMeta();
  delete meta[t.name];
  saveMeta(meta);
  renderLibrary();
  renderArtists();
}

/* =========================
   Artists view
   ========================= */
function renderArtists(){
  el.artistList.innerHTML='';
  const grouped = {};
  library.forEach(t=>{
    const a = t.artist?.trim() || '不明';
    (grouped[a] ||= []).push(t);
  });
  const names = Object.keys(grouped).sort((a,b)=>a.localeCompare(b,'ja'));
  for(const name of names){
    const sec = document.createElement('div');
    sec.style.marginBottom='12px';
    sec.innerHTML = `<div style="font-weight:600;margin-bottom:6px">${escapeHtml(name)} <span class="small">(${grouped[name].length})</span></div>`;
    const list = document.createElement('div');
    list.style.display='grid'; list.style.gridTemplateColumns='1fr auto auto'; list.style.gap='8px';
    for(const t of grouped[name]){
      const title = document.createElement('div'); title.textContent = t.title;
      const play = document.createElement('button'); play.className='btn primary'; play.textContent='▶️'; play.onclick=()=>addToQueueAndPlay(t.id);
      const edit = document.createElement('button'); edit.className='btn'; edit.textContent='ID3'; edit.onclick=()=>openId3EditorInline(t.id);
      list.append(title, play, edit);
    }
    sec.appendChild(list);
    el.artistList.appendChild(sec);
  }
}

/* =========================
   ID3 Editor
   ========================= */
function renderId3Editor(){
  el.id3Editor.innerHTML = `<div class="small">ライブラリから曲を選ぶと編集フォームが表示されます。</div>`;
}
async function openId3EditorInline(id){
  const t = library.find(x=>x.id===id); if(!t) return;
  document.querySelectorAll('.nav button').forEach(b=> b.classList.remove('active'));
  document.querySelector('.nav button[data-view="id3"]').classList.add('active');
  Object.values(views).forEach(v=> v.style.display='none');
  views.id3.style.display='block';

  el.id3Editor.innerHTML = `
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px">
      <div><label>Title</label><input id="editTitle" type="text" value="${escapeHtml(t.title)}"></div>
      <div><label>Artist</label><input id="editArtist" type="text" value="${escapeHtml(t.artist||'')}"></div>
      <div><label>Album</label><input id="editAlbum" type="text" value="${escapeHtml(t.album||'')}"></div>
      <div><label>Year</label><input id="editYear" type="number" min="0" max="9999" value="${escapeHtml(t.year||'')}"></div>
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">
      <button id="id3Cancel" class="btn">キャンセル</button>
      <button id="id3Save" class="btn primary">保存（メタデータ）</button>
    </div>
  `;
  document.getElementById('id3Cancel').onclick = ()=>{
    views.artists.style.display='block';
    document.querySelector('.nav button[data-view="artists"]').classList.add('active');
    views.id3.style.display='none';
  };
  document.getElementById('id3Save').onclick = async ()=>{
    t.title = document.getElementById('editTitle').value;
    t.artist= document.getElementById('editArtist').value;
    t.album = document.getElementById('editAlbum').value;
    t.year  = document.getElementById('editYear').value;
    const meta = loadMeta();
    meta[t.name] = { id:t.id, title:t.title, artist:t.artist, album:t.album, year:t.year, added:t.added, cover:t.cover||null };
    saveMeta(meta);
    renderLibrary();
    renderArtists();
    alert('メタデータを保存しました（ローカルストレージ）');
  };
}

/* =========================
   Queue & Player
   ========================= */
function renderQueue(){
  el.queueList.innerHTML='';
  for(const id of queue){
    const t = library.find(x=>x.id===id); if(!t) continue;
    const row = document.createElement('div');
    row.className='item';
    row.innerHTML = `
      <div style="width:36px;height:36px;border-radius:8px;overflow:hidden;border:1px solid var(--border);background:#0b0f14;display:flex;align-items:center;justify-content:center">
        ${t.cover?'<div style="width:100%;height:100%;background-size:cover;background-position:center;background-image:url('+t.cover+')"></div>':'<span class="small">♬</span>'}
      </div>
      <div style="flex:1">
        <div style="font-size:13px">${escapeHtml(t.title)}</div>
        <div class="small">${escapeHtml(t.artist||'—')}</div>
      </div>
      <button class="btn primary">▶️</button>
      <button class="btn danger">削除</button>
    `;
    row.querySelector('.btn.primary').onclick = ()=> playById(id);
    row.querySelector('.btn.danger').onclick = ()=> { queue = queue.filter(qid=>qid!==id); renderQueue(); };
    el.queueList.appendChild(row);
  }
}
function addToQueueAndPlay(id){
  if(!queue.includes(id)) queue.push(id);
  renderQueue();
  playById(id);
}
async function playById(id){
  const t = library.find(x=>x.id===id); if(!t) return;
  currentId = id;
  const url = URL.createObjectURL(t.blob);
  audio.src = url;
  audio.currentTime = 0;
  await ensureAudioChain();
  await audio.play().catch(()=>{});
  playing = !audio.paused;
  updatePlayButton();
  updateNowPlaying(t);
}
function updateNowPlaying(t){
  el.npTitle.textContent = t.title || '—';
  el.npArtist.textContent = t.artist || '—';
  if(t.cover){
    el.npCoverImg.src = t.cover;
    el.npCoverImg.style.display = 'block';
    el.npCoverNote.style.display = 'none';
  }else{
    el.npCoverImg.style.display = 'none';
    el.npCoverNote.style.display = 'block';
  }
}
function updatePlayButton(){ el.btnPlay.textContent = playing ? '⏸️' : '▶️'; }
el.btnPlay.addEventListener('click', ()=>{
  if(audio.src){
    if(audio.paused){ audio.play(); playing=true; } else { audio.pause(); playing=false; }
    updatePlayButton();
  }
});
el.btnNext.addEventListener('click', ()=>{
  const idx = queue.indexOf(currentId);
  if(idx>=0 && idx<queue.length-1) playById(queue[idx+1]);
});
el.btnPrev.addEventListener('click', ()=>{
  const idx = queue.indexOf(currentId);
  if(idx>0) playById(queue[idx-1]);
});
el.clearQueue.addEventListener('click', ()=>{ queue=[]; renderQueue(); });
el.btnEdit.addEventListener('click', ()=>{ if(currentId) openId3EditorInline(currentId); });

audio.addEventListener('timeupdate', ()=>{
  const dur = audio.duration || 0;
  const cur = audio.currentTime || 0;
  const ratio = dur ? (cur/dur) : 0;
  el.seek.value = Math.floor(ratio*1000);
  el.npBar.style.width = `${ratio*100}%`;
  el.npTime.textContent = `${fmtTime(cur)} / ${fmtTime(dur)}`;
});
el.seek.addEventListener('input', ()=>{
  const dur = audio.duration || 0;
  const target = (el.seek.value/1000)*dur;
  audio.currentTime = target;
});
audio.addEventListener('ended', ()=>{
  playing=false; updatePlayButton();
  const idx = queue.indexOf(currentId);
  if(idx>=0 && idx<queue.length-1) playById(queue[idx+1]);
});
function fmtTime(s){ return `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`; }

/* =========================
   EQ chain (WebAudio)
   ========================= */
async function ensureAudioChain(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    mediaNode = audioCtx.createMediaElementSource(audio);
    bassFilter = audioCtx.createBiquadFilter(); bassFilter.type='lowshelf'; bassFilter.frequency.value = 120;
    trebleFilter = audioCtx.createBiquadFilter(); trebleFilter.type='highshelf'; trebleFilter.frequency.value = 4000;
    boostGain = audioCtx.createGain(); boostGain.gain.value = settings.bassBoost ? 1.15 : 1.0;
    mediaNode.connect(bassFilter).connect(trebleFilter).connect(boostGain).connect(audioCtx.destination);
  }
  applyEQ();
}
function applyEQ(){
  if(bassFilter) bassFilter.gain.value = Number(settings.bass||0);
  if(trebleFilter) trebleFilter.gain.value = Number(settings.treble||0);
  if(boostGain) boostGain.gain.value = settings.bassBoost ? 1.15 : 1.0;
}

/* =========================
   Settings (Theme + EQ)
   ========================= */
function applyTheme(theme){
  document.body.classList.remove('theme-lightgreen','theme-beige','theme-lightblue');
  if(theme==='lightgreen') document.body.classList.add('theme-lightgreen');
  else if(theme==='beige') document.body.classList.add('theme-beige');
  else if(theme==='lightblue') document.body.classList.add('theme-lightblue');
}
function syncSettingsUI(){
  el.bgColor.value = settings.theme || 'default';
  el.bass.value = settings.bass || 0;
  el.treble.value = settings.treble || 0;
  el.bassBoost.checked = !!settings.bassBoost;
}
el.bgColor.addEventListener('change', ()=>{
  settings.theme = el.bgColor.value;
  applyTheme(settings.theme);
  saveSettings(settings);
});
el.bass.addEventListener('input', ()=>{
  settings.bass = Number(el.bass.value);
  applyEQ();
  saveSettings(settings);
});
el.treble.addEventListener('input', ()=>{
  settings.treble = Number(el.treble.value);
  applyEQ();
  saveSettings(settings);
});
el.bassBoost.addEventListener('change', ()=>{
  settings.bassBoost = el.bassBoost.checked;
  applyEQ();
  saveSettings(settings);
});

/* =========================
   Backup ZIP (file://でも動作)
   ========================= */
el.backupDownload.addEventListener('click', async ()=>{
  if(library.length===0) return alert('ライブラリに曲がありません。');
  const mode = el.backupMode.value;
  const zip = new JSZip();

  if(mode === 'album'){
    for(const t of library){
      const folder = zip.folder(t.album || '不明アルバム');
      folder.file(t.name, t.blob);
    }
  } else if(mode === 'playlist'){
    // 例: すべて「プレイリスト1」にまとめる（将来 playlists.json に対応）
    const folder = zip.folder('プレイリスト1');
    for(const t of library){ folder.file(t.name, t.blob); }
  } else {
    for(const t of library){ zip.file(t.name, t.blob); }
  }

  const blob = await zip.generateAsync({type:"blob"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "Backup-Music.zip";
  a.click();
});

/* =========================
   Controls & Search
   ========================= */
el.search.addEventListener('input', renderLibrary);
el.sort.addEventListener('change', renderLibrary);
el.viewGrid.addEventListener('click', ()=>{ gridView=true; el.viewGrid.classList.add('primary'); el.viewList.classList.remove('primary'); renderLibrary(); });
el.viewList.addEventListener('click', ()=>{ gridView=false; el.viewList.classList.add('primary'); el.viewGrid.classList.remove('primary'); renderLibrary(); });

/* =========================
   Workspace button (FS Access API)
   ========================= */
el.openWorkspace.addEventListener('click', async ()=>{
  // クリックイベント内で呼び出し（対応ブラウザのみ）
  if(!window.showDirectoryPicker){
    alert('このブラウザではフォルダアクセスがサポートされていません。Chromium系＋HTTPSでお試しください。');
    return;
  }
  try{
    const handle = await window.showDirectoryPicker();
    const perm = await handle.requestPermission({ mode:'read' });
    if(perm!=='granted'){ alert('フォルダへのアクセスが許可されませんでした。'); return; }
    // 読み取りのみでライブラリに追加
    library = [];
    for await (const [name, h] of handle.entries()){
      if(h.kind==='file' && name.toLowerCase().endsWith('.mp3')){
        const file = await h.getFile();
        const blob = new Blob([await file.arrayBuffer()], { type:'audio/mpeg' });
        const meta = loadMeta();
        const id = meta[name]?.id || crypto.randomUUID();
        const track = {
          id, name,
          title: meta[name]?.title || name.replace(/\.mp3$/i,''),
          artist: meta[name]?.artist || '',
          album: meta[name]?.album || '',
          year: meta[name]?.year || '',
          size: file.size,
          blob,
          cover: meta[name]?.cover || null,
          added: meta[name]?.added || Date.now()
        };
        library.push(track);
        meta[name] = { id:track.id, title:track.title, artist:track.artist, album:track.album, year:track.year, added:track.added, cover:track.cover };
        saveMeta(meta);
      }
    }
    renderLibrary();
    renderArtists();
  }catch(e){
    console.error(e);
    alert('フォルダを開けませんでした。HTTPS環境のChromium系ブラウザでお試しください。');
  }
});

/* =========================
   Init
   ========================= */
(function init(){
  applyTheme(settings.theme);
  syncSettingsUI();
  renderLibrary();
  renderArtists();
  el.npCoverImg.style.display='none';
  el.npCoverNote.style.display='block';
  updatePlayButton();
})();
</script>
</body>
</html>
